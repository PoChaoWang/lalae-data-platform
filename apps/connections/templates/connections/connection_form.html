{% extends "base.html" %}
{% block title %}Connect to {{ data_source.get_name_display }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center content-header">
        <h1>Connect to {{ data_source.get_name_display }}</h1>
        <a href="{% url 'connections:select_data_source' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Data Sources
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <form method="post" id="connectionForm" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- ===== 新增：前端驗證錯誤訊息的顯示位置 ===== -->
                        <div id="form-validation-errors" class="alert alert-danger" style="display: none;">
                            <strong>Please correct the following errors:</strong>
                            <ul id="form-error-list" class="mb-0 mt-2"></ul>
                        </div>
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
            
                        {% if data_source.name == 'GOOGLE_ADS'%}
                            <div class="mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Authorization Status</h5>
                                        <div id="authStatus" class="oauth-status mb-3">
                                            {% if oauth_status == 'authorized' %}
                                                <div class="alert alert-success" data-status="authorized">
                                                    <i class="bi bi-check-circle"></i> Authorized as: {{ google_account_email }}
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning" data-status="not-authorized">
                                                    <i class="bi bi-exclamation-triangle"></i> Not authorized
                                                </div>
                                                <div class="alert alert-info mt-3">
                                                    <i class="bi bi-info-circle"></i>
                                                    <strong>OAuth Authentication Required:</strong> You need to authorize access to your {{ data_source.get_name_display }} data before creating the connection.
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if oauth_status != 'authorized' %}
                                        <button type="button" 
                                                class="btn btn-primary oauth-authorize-btn" 
                                                data-client-id="{{ client.id }}"
                                                onclick="initiateGoogleOAuth('{{ client.id }}')">
                                            <i class="bi bi-google"></i>
                                            Authorize Google Account
                                        </button>
                                        {% else %}
                                        <button type="button" 
                                                class="btn btn-outline-primary oauth-authorize-btn" 
                                                data-client-id="{{ client.id }}"
                                                onclick="initiateGoogleOAuth('{{ client.id }}')">
                                            <i class="bi bi-arrow-clockwise"></i>
                                            Re-authorize Google Account
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% elif data_source.name == 'FACEBOOK_ADS' %}
                            <div class="mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Facebook Authorization Status</h5>
                                        <div id="facebookAuthStatus" class="oauth-status mb-3">
                                            {% if client.facebook_social_account %}
                                                <div class="alert alert-success" data-status="authorized">
                                                    <i class="bi bi-check-circle"></i> Authorized as: {{ client.facebook_social_account.extra_data.name }}
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning" data-status="not-authorized">
                                                    <i class="bi bi-exclamation-triangle"></i> Not authorized
                                                </div>
                                                <div class="alert alert-info mt-3">
                                                    <i class="bi bi-info-circle"></i>
                                                    <strong>OAuth Authentication Required:</strong> You need to authorize access to your Facebook Ads account before creating the connection.
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if not client.facebook_social_account %}
                                        <a href="{% url 'connections:client_oauth_authorize' client.id %}?data_source=FACEBOOK_ADS" 
                                           class="btn btn-primary">
                                            <i class="bi bi-facebook"></i>
                                            Authorize Facebook Account
                                        </a>
                                        {% else %}
                                        <a href="{% url 'connections:client_oauth_authorize' client.id %}?data_source=FACEBOOK_ADS" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-arrow-clockwise"></i>
                                            Re-authorize Facebook Account
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
            
                        <div class="mb-3">
                            <label for="{{ form.display_name.id_for_label }}" class="form-label">Connection Name</label>
                            {{ form.display_name }}
                            {% if form.display_name.errors %}
                            <div class="invalid-feedback">
                                {{ form.display_name.errors }}
                            </div>
                            {% endif %}
                        </div>
            
                        <div class="mb-3">
                            <label for="{{ form.target_dataset_id.id_for_label }}" class="form-label">Target Dataset ID</label>
                            {{ form.target_dataset_id }}
                            {% if form.target_dataset_id.errors %}
                            <div class="invalid-feedback">
                                {{ form.target_dataset_id.errors }}
                            </div>
                            {% endif %}
                            <div class="form-text">This is the dataset where your data will be stored.</div>
                        </div>
            
                        
            
                        {% if data_source.name == 'GOOGLE_ADS' %}
                            {% include "connections/connection_forms/google_ads.html" %}
                        {% elif data_source.name == 'YOUTUBE_CHANNEL' %}
                            {% include "connections/connection_forms/youtube_channel.html" %}
                        {% elif data_source.name == 'GOOGLE_PLAY' %}
                            {% include "connections/connection_forms/google_play.html" %}
                        {% elif data_source.name == 'GOOGLE_AD_MANAGER' %}
                            {% include "connections/connection_forms/google_ad_manager.html" %}
                        {% elif data_source.name == 'FACEBOOK_ADS' %}
                            {% include "connections/connection_forms/facebook_ads.html" %}
                        {% endif %}
            
                        <div class="mb-3">
                            <div class="row align-items-end">
                                <div class="col-md-3">
                                    <label for="{{ form.sync_frequency.id_for_label }}" class="form-label">Sync Frequency</label>
                                    {{ form.sync_frequency }}
                                    {% if form.sync_frequency.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sync_frequency.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.sync_hour.id_for_label }}" class="form-label">Hour (24h)</label>
                                    {{ form.sync_hour }}
                                    {% if form.sync_hour.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sync_hour.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.sync_minute.id_for_label }}" class="form-label">Minute</label>
                                    {{ form.sync_minute }}
                                    {% if form.sync_minute.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sync_minute.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div id="weekly-options" class="mb-3" style="display: none;">
                            <label for="{{ form.weekly_day_of_week.id_for_label }}" class="form-label">Day of Week</label>
                            {{ form.weekly_day_of_week }}
                            {% if form.weekly_day_of_week.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.weekly_day_of_week.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">Select which day of the week to sync your data.</div>
                        </div>
                        
                        <div id="monthly-options" class="mb-3" style="display: none;">
                            <label for="{{ form.monthly_day_of_month.id_for_label }}" class="form-label">Day of Month</label>
                            {{ form.monthly_day_of_month }}
                            {% if form.monthly_day_of_month.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.monthly_day_of_month.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">Select which day of the month to sync your data (1-31).</div>
                        </div>
            
                        <div class="d-grid gap-2">
                             <!-- ===== 修改：按鈕 type 改為 "button" ===== -->
                            <button type="button" class="btn btn-primary" id="submitButton">
                                Create Connection
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}

<script>
    // 全域函式，保持不變
    function initiateGoogleOAuth(clientId) {
        const authButton = document.querySelector('.oauth-authorize-btn');
        if (!authButton) return;
        const originalText = authButton.innerHTML;
        authButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Authorizing...';
        authButton.disabled = true;
        const csrftoken = getCookie('csrftoken');
        fetch("{% url 'connections:save_oauth_redirect' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                redirect_url: window.location.href,
                client_id: clientId
            })
        }).then(response => {
            if (!response.ok) {
               throw new Error('Failed to save redirect URL. Server responded with ' + response.status);
            }
            const oauthUrl = `/connections/oauth/authorize/${clientId}/?data_source=GOOGLE_ADS`;
            window.location.href = oauthUrl;
        }).catch(error => {
            console.error('Error initiating OAuth:', error);
            alert('An error occurred while starting the authorization process. Please check the console for details.');
            authButton.innerHTML = originalText;
            authButton.disabled = false;
        });
        return false;
    }

    // DOM 載入後執行的所有邏輯
    document.addEventListener('DOMContentLoaded', function() {
        // =================================================================
        // 功能 0：前端驗證邏輯 (您的版本)
        // =================================================================
        const submitButton = document.getElementById('submitButton');
        const form = document.getElementById('connectionForm');
        const errorContainer = document.getElementById('form-validation-errors');
        const errorList = document.getElementById('form-error-list');

        if (submitButton) {
            submitButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (validateForm()) {
                    form.submit();
                }
            });
        }

        function validateForm() {
            errorList.innerHTML = '';
            const errors = [];
            const authStatusDiv = document.querySelector('#authStatus [data-status], #facebookAuthStatus [data-status]');
            if (authStatusDiv && authStatusDiv.dataset.status === 'not-authorized') {
                errors.push('Authorization Status cannot be "Not authorized". Please authorize the account.');
            }
            const connectionName = document.getElementById('{{ form.display_name.id_for_label }}');
            if (connectionName && connectionName.value.trim() === '') {
                errors.push('Connection Name cannot be blank.');
            }
            const targetDatasetId = document.getElementById('{{ form.target_dataset_id.id_for_label }}');
            if (targetDatasetId && targetDatasetId.value.trim() === '') {
                errors.push('Target Dataset ID cannot be blank.');
            }
            const syncFrequencyEl = document.getElementById('{{ form.sync_frequency.id_for_label }}');
            const dayOfMonth = document.getElementById('{{ form.monthly_day_of_month.id_for_label }}');
            if (syncFrequencyEl && syncFrequencyEl.value === 'monthly' && dayOfMonth && dayOfMonth.value.trim() === '') {
                errors.push('Day of Month cannot be blank when Sync Frequency is set to Monthly.');
            }
            
            const dataSourceName = "{{ data_source.name }}";

            if (dataSourceName === 'GOOGLE_ADS') {
                const customerIdField = document.getElementById('{{ form.customer_id.id_for_label }}');
                if (customerIdField) {
                    let cleanedId = customerIdField.value.replace(/-/g, '');
                    customerIdField.value = cleanedId;
                    if (cleanedId.trim() === '') {
                        errors.push('Google Ads Customer ID cannot be blank.');
                    } else if (!/^\d+$/.test(cleanedId)) {
                        errors.push('Google Ads Customer ID must only contain numbers.');
                    }
                }
                // 驗證 hidden input 是否存在
                const hiddenInputs = document.querySelectorAll('#hidden-inputs-container input[type="hidden"]');
                if (hiddenInputs.length === 0) {
                     errors.push('You must select at least one Metric, Segment, or Attribute.');
                }
            } else if (dataSourceName === 'FACEBOOK_ADS') {
                // Facebook validation logic here...
            }

            if (errors.length > 0) {
                errors.forEach(function(error) {
                    const li = document.createElement('li');
                    li.textContent = error;
                    errorList.appendChild(li);
                });
                errorContainer.style.display = 'block';
                window.scrollTo(0, 0);
                return false;
            } else {
                errorContainer.style.display = 'none';
                return true;
            }
        }

        // =================================================================
        // 功能 1：處理 Sync Frequency 的顯示/隱藏 (您的版本)
        // =================================================================
        const syncFrequency = document.getElementById('{{ form.sync_frequency.id_for_label }}');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');

        function updateSyncOptionsVisibility() {
            if (!syncFrequency) return;
            const value = syncFrequency.value;
            if (weeklyOptions) weeklyOptions.style.display = value === 'weekly' ? 'block' : 'none';
            if (monthlyOptions) monthlyOptions.style.display = value === 'monthly' ? 'block' : 'none';
        }

        if (syncFrequency) {
            syncFrequency.addEventListener('change', updateSyncOptionsVisibility);
            updateSyncOptionsVisibility();
        }

        // =================================================================
        // 功能 2：Facebook & Google Ads 的欄位選擇 UI
        // =================================================================
        const dataSourceName = "{{ data_source.name }}";
        
        if (dataSourceName === "FACEBOOK_ADS") {
            // ... (您現有的 Facebook 相關 JS 邏輯放在這裡) ...
            
        } else if (dataSourceName === "GOOGLE_ADS") {
            // --- DOM 元素 ---
            const resourceSelect = document.getElementById('{{ form.resource_name.id_for_label }}');
            const fieldsContainer = document.getElementById('google-fields-selector-container');
            const accordionContainer = document.getElementById('fields-accordion');
            const selectedDisplay = document.getElementById('google-selected-fields-display');
            const loadingSpinner = document.getElementById('fields-loading-spinner');
            const hiddenInputsContainer = document.getElementById('hidden-inputs-container');

            // --- 狀態管理 ---
            let allAvailableFields = { metrics: [], segments: [], attributes: [] };
            let selectedFields = new Set();

            // --- 函式定義 ---
            async function fetchCompatibleFields(resourceName) {
                loadingSpinner.style.display = 'block';
                accordionContainer.innerHTML = '';
                try {
                    const response = await fetch(`{% url 'connections:api_get_compatible_google_ads_fields' %}?resource=${resourceName}`);
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    allAvailableFields = await response.json();
                    renderAvailableFields();
                } catch (error) {
                    console.error("Failed to fetch compatible fields:", error);
                    accordionContainer.innerHTML = `<div class="alert alert-danger">Failed to load fields.</div>`;
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            function renderAvailableFields() {
                accordionContainer.innerHTML = '';
                const categories = ['attributes', 'segments', 'metrics']; // 調整順序
                categories.forEach(category => {
                    const fields = allAvailableFields[category];
                    if (fields.length > 0) {
                        const categoryTitle = (category.charAt(0).toUpperCase() + category.slice(1));
                        const categoryHtml = `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-${category}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${category}">
                                        ${categoryTitle} (${fields.length})
                                    </button>
                                </h2>
                                <div id="collapse-${category}" class="accordion-collapse collapse" data-bs-parent="#fields-accordion">
                                    <div class="list-group list-group-flush field-list-container">
                                        ${fields.map(field => `
                                            <a href="#" class="list-group-item list-group-item-action" data-field-name="${field.name}">
                                                ${field.display}
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                        accordionContainer.innerHTML += categoryHtml;
                    }
                });
            }

            function renderSelectedDisplay() {
                selectedDisplay.innerHTML = '';
                if (selectedFields.size === 0) {
                    selectedDisplay.innerHTML = '<span class="text-muted fs-small">No fields selected.</span>';
                    return;
                }
                selectedFields.forEach(fullName => {
                    const badge = document.createElement('span');
                    badge.className = 'selected-item';
                    const displayName = (fullName.split('.').length > 1 ? fullName.split('.').slice(1).join('.') : fullName).replace(/_/g, ' ');
                    badge.textContent = displayName;
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'selected-item-remove';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => { toggleFieldSelection(fullName); };
                    badge.appendChild(removeBtn);
                    selectedDisplay.appendChild(badge);
                });
            }

            function syncWithHiddenInputs() {
                hiddenInputsContainer.innerHTML = '';
                selectedFields.forEach(fieldName => {
                    let category = null;
                    for (const cat of ['metrics', 'segments', 'attributes']) {
                        if (allAvailableFields[cat].some(field => field.name === fieldName)) {
                            category = cat;
                            break;
                        }
                    }
                    if (category) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = `selected_${category}`;
                        input.value = fieldName;
                        hiddenInputsContainer.appendChild(input);
                    }
                });
            }
            
            function updateAllUI() {
                accordionContainer.querySelectorAll('.list-group-item').forEach(item => {
                    item.classList.toggle('active', selectedFields.has(item.dataset.fieldName));
                });
                renderSelectedDisplay();
                syncWithHiddenInputs();
            }

            function toggleFieldSelection(fieldName) {
                if (selectedFields.has(fieldName)) {
                    selectedFields.delete(fieldName);
                } else {
                    selectedFields.add(fieldName);
                }
                updateAllUI();
            }

            // --- 事件監聽 ---
            resourceSelect.addEventListener('change', function() {
                const resourceName = this.value;
                selectedFields.clear();
                allAvailableFields = { metrics: [], segments: [], attributes: [] };
                updateAllUI();
                if (resourceName) {
                    fieldsContainer.style.display = 'block';
                    fetchCompatibleFields(resourceName);
                } else {
                    fieldsContainer.style.display = 'none';
                }
            });

            accordionContainer.addEventListener('click', function(e) {
                e.preventDefault();
                const target = e.target;
                if (target.classList.contains('list-group-item')) {
                    const fieldName = target.dataset.fieldName;
                    toggleFieldSelection(fieldName);
                }
            });

            // --- 初始載入 ---
            if (resourceSelect.value) {
                const initialFields = [
                    ...Array.from(document.querySelectorAll('select[name=selected_metrics] option:checked')),
                    ...Array.from(document.querySelectorAll('select[name=selected_segments] option:checked')),
                    ...Array.from(document.querySelectorAll('select[name=selected_attributes] option:checked'))
                ];
                initialFields.forEach(opt => selectedFields.add(opt.value));
                resourceSelect.dispatchEvent(new Event('change'));
            }
        }
    });
</script>

{% endblock extra_js %}